from google import genai
from google.genai import types
import os
import time

# ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å Environment Variable
api_key = os.getenv("GEMINI_API_KEY")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Client ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
client = None
if api_key:
    try:
        client = genai.Client(api_key=api_key)
    except Exception as e:
        print(f"‚ö†Ô∏è Error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI Client: {e}")

def aya_process_news(source_type, title, content, link, pub_date):
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö Retry ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 429
    """
    if not client:
        return "AI_ERROR: Client not initialized (Check API Key)"

    system_instruction = """
    Roleplay: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "Shameimaru Aya" (‡∏ä‡∏≤‡∏°‡∏∞‡πÄ‡∏°‡∏≤‡∏£‡∏∏ ‡∏≠‡∏≤‡∏¢‡∏∞) ‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏ó‡πá‡∏ô‡∏á‡∏π‡πÅ‡∏´‡πà‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏
    Target Audience: ‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡∏° Touhou Project ‡∏ä‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
    Core Directive:
    1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
    2. ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á" (Report) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô" (Lore)
    3. ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞!", "‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πà‡∏ß‡∏ô!")
    """

    specific_task = ""
    if source_type == "game_update":
        specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏°: ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠(Prologue)"
    elif source_type == "official":
        specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£: ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"
    elif source_type == "magazine":
        specific_task = "‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°: ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
    elif source_type == "community":
        specific_task = "Reddit: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Fan Art ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á Lore ‡πÄ‡∏û‡∏¥‡πà‡∏°! ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤"

    full_prompt = f"""
    {system_instruction}
    --------------------------------
    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {specific_task}
    
    [‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á]
    Headline: {title}
    Date: {pub_date}
    Content Snippet: {content}
    Link: {link}
    
    [‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö]
    (‡∏´‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå: SKIP)
    
    üì∑ **[‡∏û‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏]**
    "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞! <‡∏ö‡∏ó‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏≤‡∏¢‡∏∞>"
    
    üìú **‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß:**
    <‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ>
    - ...
    
    (‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ Lore ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡πÉ‡∏ô Fan Art)
    üìñ **‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠:**
    <‡πÅ‡∏õ‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠>
    
    üå™Ô∏è **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏¢‡∏∞:** <‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ã‡∏ß‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£>
    """

    # [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏à‡πâ‡∏á (‡∏ï‡∏±‡∏î 1.0/1.5 ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    models_to_try = [
        "gemini-2.0-flash-exp",      # ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Ñ‡∏™‡∏∏‡∏î
        "gemini-2.0-flash",          # ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á
        "gemini-3.0-flash-preview",  # 3.0 Flash ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠
        "gemini-3.0-pro-preview"     # 3.0 Pro ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠
    ]

    # ‡∏£‡∏∞‡∏ö‡∏ö Retry (‡∏•‡∏≠‡∏á‡∏ß‡∏ô‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ)
    for model_name in models_to_try:
        try:
            response = client.models.generate_content(
                model=model_name,
                contents=full_prompt
            )
            return response.text.strip()
            
        except Exception as e:
            error_msg = str(e)
            
            # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î Quota (429) ‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ô‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô
            if "429" in error_msg:
                wait_time = 40 
                print(f"‚ö†Ô∏è ‡∏ï‡∏¥‡∏î Error 429 (Quota) ‡∏ó‡∏µ‡πà‡πÇ‡∏°‡πÄ‡∏î‡∏• {model_name}.. ‡∏û‡∏±‡∏Å {wait_time} ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ")
                time.sleep(wait_time)
            
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 404 (‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠) ‡∏´‡∏£‡∏∑‡∏≠ Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏¢
            else:
                print(f"‚ö†Ô∏è Error ({model_name}): {error_msg} -> ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô")
    
    return "AI_ERROR: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ (‡∏•‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡πâ‡∏ß)"
