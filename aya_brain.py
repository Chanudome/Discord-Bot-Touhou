from google import genai
from google.genai import types
import os
import time

# ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å Environment Variable
api_key = os.getenv("GEMINI_API_KEY")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Client ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
client = None
if api_key:
    try:
        client = genai.Client(api_key=api_key)
    except Exception as e:
        print(f"‚ö†Ô∏è Error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI Client: {e}")

def get_available_models():
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API Key ‡∏ô‡∏µ‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 404/429)
    """
    if not client:
        return []
    
    try:
        # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà Key ‡∏ô‡∏µ‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô
        all_models = list(client.models.list())
        
        # ‡∏Ñ‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ (generateContent)
        valid_models = []
        for m in all_models:
            if 'generateContent' in m.supported_generation_methods:
                # ‡∏ï‡∏±‡∏î models/ ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                clean_name = m.name.replace('models/', '')
                valid_models.append(clean_name)
        
        # ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÉ‡∏ä‡πâ: Flash (‡πÄ‡∏£‡πá‡∏ß/‡∏ü‡∏£‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞) -> Pro
        def sort_key(name):
            score = 0
            if 'flash' in name: score += 100
            if '1.5' in name: score += 50
            if '2.0' in name: score += 40
            if 'exp' in name: score -= 10
            return score

        valid_models.sort(key=sort_key, reverse=True)
        
        print(f"üìã ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ({len(valid_models)} ‡∏ï‡∏±‡∏ß): {valid_models}")
        return valid_models

    except Exception as e:
        print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏î‡πâ: {e}")
        # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏¢
        return ["gemini-1.5-flash", "gemini-2.0-flash-exp"]

def aya_process_news(source_type, title, content, link, pub_date):
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ AI ‡∏™‡∏ß‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏Ç‡πà‡∏≤‡∏ß
    """
    if not client:
        return "AI_ERROR: Client not initialized (Check API Key)"

    system_instruction = """
    Roleplay: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "Shameimaru Aya" (‡∏ä‡∏≤‡∏°‡∏∞‡πÄ‡∏°‡∏≤‡∏£‡∏∏ ‡∏≠‡∏≤‡∏¢‡∏∞) ‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏ó‡πá‡∏ô‡∏á‡∏π‡πÅ‡∏´‡πà‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏
    Target Audience: ‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡∏° Touhou Project ‡∏ä‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
    Core Directive:
    1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
    2. ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á" (Report) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô" (Lore)
    3. ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞!", "‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πà‡∏ß‡∏ô!")
    """

    specific_task = ""
    if source_type == "game_update":
        specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏°: ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠(Prologue)"
    elif source_type == "official":
        specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£: ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"
    elif source_type == "magazine":
        specific_task = "‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°: ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
    elif source_type == "community":
        specific_task = "Reddit: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Fan Art ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á Lore ‡πÄ‡∏û‡∏¥‡πà‡∏°! ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤"

    full_prompt = f"""
    {system_instruction}
    --------------------------------
    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {specific_task}
    
    [‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á]
    Headline: {title}
    Date: {pub_date}
    Content Snippet: {content}
    Link: {link}
    
    [‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö]
    (‡∏´‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå: SKIP)
    
    üì∑ **[‡∏û‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏]**
    "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞! <‡∏ö‡∏ó‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏≤‡∏¢‡∏∞>"
    
    üìú **‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß:**
    <‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ>
    - ...
    
    (‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ Lore ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡πÉ‡∏ô Fan Art)
    üìñ **‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠:**
    <‡πÅ‡∏õ‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠>
    
    üå™Ô∏è **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏¢‡∏∞:** <‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ã‡∏ß‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£>
    """

    # 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
    models_to_try = get_available_models()
    
    if not models_to_try:
        return "AI_ERROR: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ API Key)"

    # 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß
    for model_name in models_to_try:
        try:
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI (Client-based)
            response = client.models.generate_content(
                model=model_name,
                contents=full_prompt
            )
            return response.text.strip()
            
        except Exception as e:
            error_msg = str(e)
            
            # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î Quota (429) ‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if "429" in error_msg:
                print(f"‚ö†Ô∏è ‡πÇ‡∏°‡πÄ‡∏î‡∏• {model_name} ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° (429).. ‡∏û‡∏±‡∏Å 5 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß")
                time.sleep(5)
            
            # ‡∏ñ‡πâ‡∏≤ Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°
            else:
                print(f"‚ö†Ô∏è Error ({model_name}): {error_msg} -> ‡∏Ç‡πâ‡∏≤‡∏°")
    
    return "AI_ERROR: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ (‡∏•‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß)"
