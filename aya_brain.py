import google.generativeai as genai
import os

# ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å Environment Variable (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub)
api_key = os.getenv("GEMINI_API_KEY")

if api_key:
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-1.5-flash-001')
else:
    model = None
    print("‚ö†Ô∏è Warning: ‡πÑ‡∏°‡πà‡∏û‡∏ö GEMINI_API_KEY ‡πÉ‡∏ô Environment Variables")

def aya_process_news(source_type, title, content, link, pub_date):
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ AI ‡∏™‡∏ß‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏Ç‡πà‡∏≤‡∏ß
    """
    if not model:
        return "AI_ERROR: Missing API Key"

    try:
        # --- System Prompt: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ---
        system_instruction = """
        Roleplay: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "Shameimaru Aya" (‡∏ä‡∏≤‡∏°‡∏∞‡πÄ‡∏°‡∏≤‡∏£‡∏∏ ‡∏≠‡∏≤‡∏¢‡∏∞) ‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏ó‡πá‡∏ô‡∏á‡∏π‡πÅ‡∏´‡πà‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏
        Target Audience: ‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡∏° Touhou Project ‡∏ä‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
        
        Core Directive:
        1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
        2. ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á" (Report) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô" (Lore)
        3. ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞!", "‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πà‡∏ß‡∏ô!")
        4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ZUN ‡∏ß‡πà‡∏≤ "‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏±‡∏ô‡∏ô‡∏∏‡∏ä‡∏¥"
        """

        # --- Context Instruction: ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πà‡∏≤‡∏ß ---
        specific_task = ""
        if source_type == "game_update":
            specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏°/Patch Note: ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' ‡∏Å‡∏±‡∏ö '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠(Prologue)' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢!"
        elif source_type == "official":
            specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£: ‡∏™‡∏£‡∏∏‡∏õ ‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"
        elif source_type == "magazine":
            specific_task = "‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå: ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 3-4 ‡∏Ç‡πâ‡∏≠"
        elif source_type == "community":
            specific_task = "Reddit: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏°‡∏µ‡∏°‡∏ï‡∏•‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ß‡πà‡∏≤ 'SKIP' ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏≤‡∏°‡∏≤"

        # --- Full Prompt Construction ---
        full_prompt = f"""
        {system_instruction}
        --------------------------------
        ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {specific_task}
        
        [‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á]
        Headline: {title}
        Date: {pub_date}
        Content Snippet: {content}
        Link: {link}
        
        [‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (Output Format)]
        (‡∏´‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå: SKIP)
        
        üì∑ **[‡∏û‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏]**
        
        "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞! <‡∏ö‡∏ó‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏≤‡∏¢‡∏∞>"
        
        üìú **‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß:**
        <‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ>
        - ...
        
        (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πà‡∏≤‡∏ß‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/Story ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á)
        üìñ **‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠:**
        <‡πÅ‡∏õ‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ö‡∏ó‡∏û‡∏π‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏Ç‡πà‡∏≤‡∏ß>
        
        üå™Ô∏è **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏¢‡∏∞:** <‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ã‡∏ß‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£>
        """

        # ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        response = model.generate_content(full_prompt)
        return response.text.strip()

    except Exception as e:
        return f"AI_ERROR: {str(e)}"
