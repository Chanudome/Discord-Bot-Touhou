from google import genai
import os
import time

# ‡∏î‡∏∂‡∏á Key ‡∏à‡∏≤‡∏Å Environment Variable
api_key = os.getenv("GEMINI_API_KEY")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Client ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
client = None
if api_key:
    try:
        client = genai.Client(api_key=api_key)
    except Exception as e:
        print(f"‚ö†Ô∏è Error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI Client: {e}")

def get_valid_models():
    """
    ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Key ‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©)
    """
    if not client: return []
    
    discovered_models = []
    try:
        print("üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å API...")
        for m in client.models.list():
            model_name = getattr(m, 'name', '')
            
            # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏• Gemini
            if 'gemini' in model_name:
                clean_name = model_name.replace('models/', '')
                
                # [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Text Generation ‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏ä‡πà‡∏ô TTS, Vision-only)
                if 'tts' in clean_name or 'audio' in clean_name or 'embedding' in clean_name:
                    continue
                    
                if 'flash' in clean_name or 'pro' in clean_name:
                    discovered_models.append(clean_name)
        
        print(f"   -> ‡πÄ‡∏à‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á: {len(discovered_models)} ‡∏ï‡∏±‡∏ß")
    except Exception as e:
        print(f"‚ö†Ô∏è ‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
    
    return discovered_models

def aya_process_news(source_type, title, content, link, pub_date):
    if not client:
        return "AI_ERROR: Client not initialized (Check API Key)"

    system_instruction = """
    Roleplay: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "Shameimaru Aya" (‡∏ä‡∏≤‡∏°‡∏∞‡πÄ‡∏°‡∏≤‡∏£‡∏∏ ‡∏≠‡∏≤‡∏¢‡∏∞) ‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏ó‡πá‡∏ô‡∏á‡∏π‡πÅ‡∏´‡πà‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏
    Target Audience: ‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡∏° Touhou Project ‡∏ä‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
    Core Directive:
    1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
    2. ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á" (Report) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô" (Lore)
    3. ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô (‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞!", "‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πà‡∏ß‡∏ô!")
    """

    specific_task = ""
    if source_type == "game_update":
        specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏°: ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠(Prologue)"
    elif source_type == "official":
        specific_task = "‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£: ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"
    elif source_type == "magazine":
        specific_task = "‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°: ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
    elif source_type == "community":
        specific_task = "Reddit: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Fan Art ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏á Lore ‡πÄ‡∏û‡∏¥‡πà‡∏°! ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤"

    full_prompt = f"""
    {system_instruction}
    --------------------------------
    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {specific_task}
    
    [‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á]
    Headline: {title}
    Date: {pub_date}
    Content Snippet: {content}
    Link: {link}
    
    [‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö]
    (‡∏´‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå: SKIP)
    
    üì∑ **[‡∏û‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ö‡∏∏‡∏ô‡∏ö‡∏∏‡∏ô‡∏°‡∏≤‡∏£‡∏∏]**
    "‡∏≠‡∏≤‡∏¢‡∏∞‡∏¢‡∏∞! <‡∏ö‡∏ó‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏≤‡∏¢‡∏∞>"
    
    üìú **‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß:**
    <‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ>
    - ...
    
    (‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ Lore ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡πÉ‡∏ô Fan Art)
    üìñ **‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠:**
    <‡πÅ‡∏õ‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠>
    
    üå™Ô∏è **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏¢‡∏∞:** <‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ã‡∏ß‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£>
    """

    # 1. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏° 3.0 ‡πÅ‡∏•‡∏∞ Thinking Model)
    models_to_try = [
        "gemini-2.0-flash-thinking-exp-01-21", # ‡∏ï‡∏±‡∏ß‡∏•‡∏±‡∏ö! ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô
        "gemini-2.0-flash-exp",
        "gemini-3.0-flash-preview", # [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà 3.0
        "gemini-3.0-pro-preview",   # [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà 3.0
        "gemini-2.5-flash",
        "gemini-2.0-flash",      
        "gemini-1.5-flash",          
        "gemini-1.5-flash-8b",       
        "gemini-2.5-pro",
    ]

    # 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏à‡∏≠‡πÄ‡∏≠‡∏á
    try:
        fallback_list = get_valid_models()
        for m in fallback_list:
            if m not in models_to_try:
                models_to_try.append(m)
    except Exception as e:
        print(f"‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: {e}")

    # ‡∏£‡∏∞‡∏ö‡∏ö Retry
    for i, model_name in enumerate(models_to_try):
        try:
            response = client.models.generate_content(
                model=model_name,
                contents=full_prompt
            )
            return response.text.strip()
            
        except Exception as e:
            error_msg = str(e)
            
            # 429 Quota Exceeded (‡∏û‡∏±‡∏Å‡∏¢‡∏≤‡∏ß)
            if "429" in error_msg:
                wait_time = 60 * (i + 1)
                if wait_time > 300: wait_time = 300 # ‡∏ï‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏ô‡∏≤‡∏ó‡∏µ
                print(f"‚ö†Ô∏è ‡πÇ‡∏°‡πÄ‡∏î‡∏• {model_name} ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° (429).. ‡∏û‡∏±‡∏Å {wait_time} ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ")
                time.sleep(wait_time)
            
            # 503 Unavailable/Overloaded (‡∏û‡∏±‡∏Å‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°)
            elif "503" in error_msg:
                print(f"‚ö†Ô∏è ‡πÇ‡∏°‡πÄ‡∏î‡∏• {model_name} ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πà‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (503).. ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô")
            
            # Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (400, 404)
            else:
                print(f"‚ö†Ô∏è ‡πÇ‡∏°‡πÄ‡∏î‡∏• {model_name} ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ({error_msg}) -> ‡∏Ç‡πâ‡∏≤‡∏°")
    
    return "AI_ERROR: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ (‡∏•‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡πâ‡∏ß)"
